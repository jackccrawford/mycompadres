# mVara Website RWA — Session Handoff

## Project Quick Facts
- **Tech Stack:** React 18.3.1, React Native 0.76.7, TypeScript 5.7.3, Expo 52.0.33, React Navigation 7.x, React Native Paper
- **Architecture:** Modular React Native/Expo app, Netlify functions for backend API, CI/CD via GitHub Actions
- **Branding:** Always use "mVara" (lowercase 'm', uppercase 'V')

## Current State (as of 2025-04-28)
- `main` branch is now an exact copy of `april-candidate` (force reset, all obsolete code removed)
- All feature, style, and modal updates from the last session are present
- All merge conflicts and lockfile issues resolved (npm ci now passes)
- All new/renamed files from april-candidate are present on main
- Email templates updated with white mVara logo and fixed header alignment
- Unsubscribe functionality enhanced to include email address in admin notifications
- YouTube video in PartnershipSection now fully responsive on mobile devices
- New CTA button system implemented with vibrant orange color (#D3824B) maintaining pill shape design
- Comprehensive documentation added for the CTA button system

## Outstanding Tasks
- Continue Netlify function development for production
- Test full app on main (locally and CI)
- (Optional) Clean up old branches and PRs
- (Optional) Run `npm audit fix` for moderate vulnerabilities
- Consider implementing the CTA button style for other key action buttons throughout the app

## Key Decisions
- "Code is Truth" — main branch always reflects current working state
- Visual confirmation of UI changes is required (see user memory)
- mVara branding and naming conventions are strictly enforced
- All obsolete code from old main has been replaced
- Button styling must maintain pill shape (borderRadius: 9999)
- CTA buttons use vibrant orange color (#D3824B) for better visibility

## Recent Improvements
1. **Email Template Enhancements**
   - Updated all email templates to use white mVara logo
   - Fixed header alignment for consistent appearance across devices
   - Created local preview HTML files for development testing

2. **Unsubscribe Functionality**
   - Enhanced to store and notify both token and email address
   - Admin notifications now include email, token, and timestamp
   - Improved URL parameter handling in UnsubscribeScreen
   - Implemented Netlify Blobs for persistent storage of unsubscribe data
   - Added redundancy with both Blobs storage and email notifications
   - Fixed production issues by explicitly providing required credentials

3. **Mobile Responsiveness**
   - Made YouTube video in PartnershipSection fully responsive
   - Implemented 100% width display on mobile devices

4. **UI Enhancements**
   - Implemented new CTA button system with vibrant orange color
   - Created specialized CTAButton component that maintains pill shape
   - Updated theme system to include CTA color as tertiary color
   - Added comprehensive documentation for the button system

## Documentation
- New CTA button documentation available at `/docs/CTAButtonDocumentation.md`
- Email template preview files available for both business and personal variants
- Local preview HTML files created for email template development

## Environment Variables

The following environment variables are required for the application to function properly:

- `RESEND_API_KEY`: API key for Resend email service
- `NETLIFY_API_TOKEN`: Personal Access Token for Netlify Blobs API
- `SITE_ID`: Netlify site ID (defaults to production site: "59be53b3-b8d2-4f24-b3a2-fe876709471d")

These should be set in both your local `.env.local` file for development and in the Netlify environment variables for production.

## Unsubscribe Management

The unsubscribe functionality has been implemented using Netlify Blobs for persistent storage. When a user unsubscribes, their email and timestamp are stored in the `unsubscribes` Blobs store, keyed by the unsubscribe token.

### Viewing Unsubscribe Records

There are several ways to view unsubscribe records:

1. **Web Interface**: Navigate to `https://mvara.ai/.netlify/functions/list-unsubscribes` to view a formatted list of unsubscribe records.

2. **CLI Commands**:
   ```bash
   # List all unsubscribe tokens
   netlify blobs:list unsubscribes
   
   # View details for a specific token
   netlify blobs:get unsubscribes <token>
   ```

3. **Node.js Script**:
   ```bash
   # Run the unsubscribe listing script
   node scripts/list-unsubscribes.js
   ```

## Assessment Request Storage

Assessment requests are now also stored in Netlify Blobs for redundancy and easy access. When a user submits an assessment request, their information is stored in the `assessment-requests` Blobs store, keyed by a unique UUID.

### Viewing Assessment Requests

Assessment requests can be viewed using the Netlify CLI:

```bash
# List all assessment request IDs
netlify blobs:list assessment-requests

# View details for a specific request
netlify blobs:get assessment-requests <request-id>
```

## Next Steps
1. Continue development from main
2. Deploy/test as needed
3. Use this document for future session handoff or onboarding

## What I (the next AI or dev) would want to know:
1. **Navigation:**
   - Are all navigation flows (esp. hidden tabs and drawer) working as intended?
   - Is the WindsurfPartnershipScreen reachable from everywhere it should be?
   - Any custom navigation logic or hacks to be aware of?
2. **Branding/Design:**
   - Are all mVara branding guidelines (logo, color, text case) being followed?
   - Any recent design changes or Figma references to check?
3. **Testing/QA:**
   - What platforms/browsers have been tested?
   - Any known bugs (esp. with navigation, responsiveness, or image rendering)?
4. **Dependencies/Setup:**
   - Any issues with npm/yarn install or Expo Go?
   - Any special environment or .env requirements?
5. **Process:**
   - What is the preferred workflow for PRs, branches, and deployments?
   - Is Netlify the only production deploy target?

## TODO

- [x] Fix dark mode default and persistence
- [x] Fix unsubscribe (still not working) Unsubscribe functionality fixed using Netlify Blobs
- [x] Store assessment requests in Netlify Blobs for redundancy
- [ ] Create a web interface for viewing assessment requests similar to unsubscribe records
- [ ] Add pagination to the unsubscribe and assessment request viewers
- [ ] Implement analytics tracking for unsubscribe events
- [ ] Address test failures:
  1. **ResponsiveImage Component Test**: Fix `jest.spyOn` usage on existing methods
  2. **Netlify Contact Function Tests**: Mock API calls to avoid reliance on running server
  3. **React Native Component Tests**: Mock StyleSheet and other RN modules
  4. **ThemeToggle Component**: Mock lucide-react-native for test environment
  5. **Jest Configuration**: Update setupFiles for proper mocking and environment

---

*Add any session-specific notes, blockers, or discoveries below as you work!*

_Last updated: 2025-04-28 by Cascade AI_
